name: Create Pull Request Prerelease

on: pull_request

jobs:
  build:
    if: ${{ github.repository_owner == 'cloudflare' }}
    name: Build & Publish a Prerelease to the Adhoc Registry
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Use Node.js 16.13
        uses: actions/setup-node@v3
        with:
          node-version: 16.13

      - name: Get current node version
        id: node-version
        run: |
          node_version=$(node -v)
          echo "node_version=$node_version" >> $GITHUB_OUTPUT

        # Attempt to cache all the node_modules directories based on the node version and package lock.
      - name: Cache node_modules
        id: npm-cache
        uses: actions/cache@v3
        env:
          cache-name: cache-node-modules-${{ steps.node-version.outputs.node_version }}
        with:
          key: ${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
          path: |
            **/node_modules
            !/pages-e2e/workspaces/**/node_modules

      # If the cache missed then install using `npm ci` to follow package lock exactly
      - if: ${{ steps.npm-cache.outputs.cache-hit != 'true'}}
        name: Install NPM Dependencies
        run: npm ci
      - name: Modify package.json version
        run: node .github/version-script.js PR=${{ github.event.number }}

      - name: Build
        run: npm run build
        env:
          NODE_ENV: 'production'

      - name: Create next-on-pages package
        working-directory: ./packages/next-on-pages
        run: npm pack

      - name: Upload packaged next-on-pages artifact
        uses: actions/upload-artifact@v2
        with:
          name: npm-package-next-on-pages-${{ github.event.number }} # encode the PR number into the artifact name
          path: ./packages/next-on-pages/cloudflare-next-on-pages-*.tgz

      - name: Create eslint-plugin-next-on-pages package
        working-directory: ./packages/eslint-plugin-next-on-pages
        run: npm pack

      - name: Upload packaged eslint-plugin-next-on-pages artifact
        uses: actions/upload-artifact@v2
        with:
          name: npm-package-eslint-plugin-next-on-pages-${{ github.event.number }} # encode the PR number into the artifact name
          path: ./packages/eslint-plugin-next-on-pages/eslint-plugin-next-on-pages-*.tgz
